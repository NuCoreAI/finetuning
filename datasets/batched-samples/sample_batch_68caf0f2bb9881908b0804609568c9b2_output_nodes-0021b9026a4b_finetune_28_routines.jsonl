{"messages": [{"role": "system", "content": "You are a NuCore smart-home assistant. You convert the user\u2019s request into one or more NuCore routines based on the provided DEVICE STRUCTURE.\n\n## NuCore BASICS\nNuCore is a platform for managing and automating smart devices through structured commands and logic.\nDevices are provided in a flattened format under DEVICE STRUCTURE.\nEach device begins with the label \"***Device***\" and may include:\n\n1. Properties: Real-time values such as status, temperature, brightness\n2. Accepts Commands: Actions that can be sent to the device (e.g., DON, DOF)\n3. Sends Commands: Events emitted by the device\n4. Parameters: Attributes for commands \u2014 id, name, type, unit (UOM), precision, enum, or range\n\nNOTE: Device boundaries are defined by the \"***Device***\" labels. Never mix properties or commands across devices.\n\n## Change of State (COS) \nA COS event occurs when a device property or status transitions from one value to another (e.g., OFF \u2192 ON, Closed \u2192 Open, 72\u00b0F \u2192 73\u00b0F). It represents the moment of change, not the steady state.\n\n## Change of Control (COC):\nA COC event occurs when a device is physically controlled (e.g., tapping a wall switch, pressing a button, adjusting a knob), regardless of whether the state actually changes. It represents the act of human control, not just the resulting status.\n\n## When to Act\nWhen the user asks for automated and optimized behavior. Such as \"turn on the security system when I leave home\", or \"charge my car when prices are lowest\", or \"water the plants every Tuesday, Thursday, Friday from 9AM to 11AM but not when it's raining\", etc.\n\n## CRITICAL RULES\n- Do provide reasoning, thinking, or any explanations unless otherwise requested\n- Put reasoning inside the routine schema\n- Do not guess, invent, or hallucinate IDs, parameters, units, or values.\n- Only use what is explicitly defined in the DEVICE STRUCTURE.\n- Remain minimal, structured, and consistent."}, {"role": "user", "content": "DEVICE STRUCTURE:\n***Device***\nName: ZY 185 SC Basic Control\nID: ZY185_251\nParent: GAR0-SENSOR_01-ZY185 [ID: ZY185_1]\n  ***Accept Commands***\n    Query [id=QUERY]\n  ***Send Commands***\n    On [id=DON]\n    Off [id=DOF]***Device***\nName: KDR0-SENSOR-ZY201\nID: ZY201_1\n  ***Properties***\n    Home Security [id=ALARM]\n    Battery Level [id=BATLVL]\n    Responding [id=ERR]\n      Enum [uom id=25]\n        True [0]\n        False [1]\n  ***Accept Commands***\n    Query [id=QUERY]\n    Set Configuration [id=CONFIG]\n        Parameter 1: name=Parameter Number [id=NUM]\n        Parameter 2: name=Parameter Value [id=VAL]\n          Range 0 to 255 Unit 1 Byte (Unsigned) [uom id=107]\n          Range 0 to 65535 Unit 2 Bytes (Unsigned) [uom id=108]\n          Range 0 to 4294967295 Unit 4 Bytes (Unsigned) [uom id=110]\n          Range -128 to 127 Unit 1 Byte [uom id=111]\n          Range -32768 to 32767 Unit 2 Byte [uom id=112]\n          Range -2147483648 to 214748647 Unit 4 Byte [uom id=114]\n    Write Changes [id=WDU]***Device***\nName: ZY 201 Tamper Alarm\nID: ZY201_157\nParent: KDR0-SENSOR-ZY201 [ID: ZY201_1]\n  ***Properties***\n    Status [id=ST]\n      Enum [uom id=78]\n        Off [0]\n        On [100]\n  ***Accept Commands***\n    Query [id=QUERY]\n  ***Send Commands***\n    On [id=DON]\n    Off [id=DOF]\n\nUSER QUERY: When the ZY 201 Tamper Alarm (ZY201_157) changes to On, if it's between 22:00 and 06:00 (overnight) query the parent sensor ZY201_1 and write changes (WDU) to it; if the tamper turns On outside that window just query the tamper device. Also, when the tamper changes to Off always query the parent sensor."}, {"role": "assistant", "content": "__BEGIN_NUCORE_ROUTINE__\n{\n  \"routine\": {\n    \"id\": 101,\n    \"name\": \"Tamper On (overnight) -> Query parent and WDU\",\n    \"parent\": 0,\n    \"comment\": \"Trigger when tamper status becomes On during overnight window\",\n    \"if\": [\n      { \"==\": { \"device\": \"ZY201_157\", \"status\": \"ST\", \"value\": 100, \"uom\": \"78\" } },\n      { \"and\": 1 },\n      { \"from\": { \"time\": \"22:00\", \"to\": { \"time\": \"06:00\", \"day\": 1 } } }\n    ],\n    \"then\": [\n      { \"device\": \"ZY201_1\", \"command\": \"QUERY\" },\n      { \"device\": \"ZY201_1\", \"command\": \"WDU\" }\n    ],\n    \"else\": [\n      { \"device\": \"ZY201_157\", \"command\": \"QUERY\" }\n    ],\n    \"reasoning\": \"Separate overnight handling required: when tamper goes On during the overnight window we query the parent and persist changes (WDU). If tamper goes On outside that window we only query the tamper device. The else branch here handles the On-but-not-overnight case for this specific COS trigger.\"\n  }\n}\n__END_NUCORE_ROUTINE__\n__BEGIN_NUCORE_ROUTINE__\n{\n  \"routine\": {\n    \"id\": 102,\n    \"name\": \"Tamper Off -> Query parent\",\n    \"parent\": 0,\n    \"comment\": \"When tamper changes to Off always query parent sensor\",\n    \"if\": [\n      { \"==\": { \"device\": \"ZY201_157\", \"status\": \"ST\", \"value\": 0, \"uom\": \"78\" } }\n    ],\n    \"then\": [\n      { \"device\": \"ZY201_1\", \"command\": \"QUERY\" }\n    ],\n    \"else\": [],\n    \"reasoning\": \"A separate routine captures the COS to Off and ensures the parent sensor is queried whenever the tamper clears. Kept separate for clarity and precise COS handling.\"\n  }\n}\n__END_NUCORE_ROUTINE__"}]}
